@startuml
' !theme vibrant
title Fluxo de Atualização de Oportunidade (Orientado a Eventos)

actor "Usuário" as user
box "Zoho CRM" #LightBlue
    participant "Interface do CRM" as crm_ui
    participant "Motor de Regras\n(Workflow Rule)" as crm_rules
end box

participant "API Producer" as api
queue "Fila de Atualização\nde Oportunidade" as queue
participant "Serviço Consumidor" as consumer
database "Banco de Dados" as db

user -> crm_ui: Atualiza oportunidade
activate crm_ui

crm_ui -> crm_rules: Aciona verificação de regras
activate crm_rules
note right: A regra é: "Se estágio mudou,\ndisparar webhook"

' A regra é atendida e dispara o webhook de forma assínrona
crm_rules ->> api: **Webhook** com dados da oportunidade
deactivate crm_rules
crm_ui --> user: Confirmação (UI Update)
deactivate crm_ui

activate api
api -> queue: Publica mensagem
deactivate api

... some time later ...

consumer -> queue: Lê mensagem da fila
activate consumer
consumer -> db: Processa e atualiza dados
activate db
db --> consumer: Confirmação
deactivate db
deactivate consumer

@enduml
